<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTENT ENGINE ‚Ä¢ TRIPLE MODE</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- CSS Utama -->
    <link rel="stylesheet" href="css/style-utama.css">
    <!-- CSS Mode akan dimuat via JS -->
    <link rel="stylesheet" href="css/style-fakta.css" id="mode-css">
</head>
<body>
    <div class="device-info" id="deviceInfo" style="display: none;">
        <span>üñ•Ô∏è Device:</span>
        <span class="device-id" id="deviceId"></span>
    </div>

    <!-- Modal Access Key -->
    <div id="accessKeyModal" class="modal-overlay">
        <div class="modal-content">
            <h2>üîë Masukkan Access Key</h2>
            <p>Silakan masukkan access key Anda.</p>
            <input type="text" id="accessKeyInput" class="modal-input" placeholder="Enter Key" autocomplete="off">
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="validateAccessKey()">MASUK</button>
            </div>
            <div id="errorMessage" class="error-message">
                <i>‚ö†Ô∏è</i> <span id="errorText"></span>
            </div>
            <div class="key-format-info">
                <p>Hubungi admin @nafassamping</p>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>‚ö°CONTENT ENGINE ‚Ä¢ TRIPLE MODE‚ö°</h1>
            <div class="sub">PILIH MODE KONTEN ANDA</div>
        </div>

        <!-- MODE TOGGLE BUTTONS - 3 MODE -->
        <div class="mode-toggle">
            <button class="mode-btn mode-fakta active" id="modeFaktaBtn" onclick="switchMode('fakta')">
                üåç FAKTA UNIK RANDOM
            </button>
            <button class="mode-btn mode-skeleton" id="modeSkeletonBtn" onclick="switchMode('skeleton')">
                üíÄ MANUSIA TENGKORAK
            </button>
            <button class="mode-btn mode-islami" id="modeIslamiBtn" onclick="switchMode('islami')">
                üïå KISAH ISLAMI
            </button>
        </div>
        <div class="mode-indicator" id="modeIndicator">üåç Mode: Fakta Unik Random</div>
        
        <!-- STATISTICS -->
        <div class="stats-grid">
            <div class="stat-card stat-total"><div class="stat-label">Total Jobs</div><div class="stat-value" id="stat-total">0</div></div>
            <div class="stat-card stat-comp"><div class="stat-label">Generated</div><div class="stat-value" id="stat-gen">0</div></div>
            <div class="stat-card stat-succ"><div class="stat-label">Success</div><div class="stat-value" id="stat-succ">0</div></div>
            <div class="stat-card stat-fail"><div class="stat-label">Failed</div><div class="stat-value" id="stat-fail">0</div></div>
        </div>

        <textarea id="hiddenCopyArea" class="hidden-textarea" readonly></textarea>
        
        <!-- API SECTION dengan TOGGLE ON/OFF -->
        <div class="api-mini">
            <div class="api-row">
                <input type="password" id="groqKey" class="api-input" placeholder="GROQ API Key" autocomplete="off">
                <button class="api-btn" onclick="saveGroq()">SAVE</button>
            </div>
            <div class="api-row">
                <input type="password" id="elevenKey" class="api-input" placeholder="ElevenLabs Key">
                <button class="api-btn eleven" onclick="saveEleven()">SAVE</button>
            </div>
            
            <!-- Toggle Switch ElevenLabs -->
            <div class="toggle-container">
                <div class="toggle-item">
                    <span class="toggle-label">üîä Generate Voice</span>
                    <label class="switch">
                        <input type="checkbox" id="elevenToggle" checked onchange="toggleEleven()">
                        <span class="slider round"></span>
                    </label>
                    <span class="toggle-status" id="elevenToggleStatus">ON</span>
                </div>
                <div class="toggle-info" id="elevenToggleInfo">
                    <span>üéôÔ∏è Voice akan digenerate</span>
                </div>
            </div>
            
            <div class="status-mini">
                <div class="status-item"><span class="status-dot" id="groqDot"></span><span id="groqStatus">STATUS: OFF</span></div>
                <div class="status-item"><span class="status-dot" id="elevenDot"></span><span id="elevenStatus">STATUS: OFF</span></div>
            </div>
        </div>

        <!-- SLIDER KONTROL JUMLAH ADEGAN - VERSI BAGUS -->
        <div class="scene-slider-container">
            <div class="slider-header">
                <div class="slider-label">
                    <i>üìä</i>
                    <span>Jumlah Adegan</span>
                </div>
                <div class="slider-value-container">
                    <span class="slider-value" id="sceneCountValue">5</span>
                    <span class="slider-unit">scene</span>
                </div>
            </div>
            
            <div class="slider-wrapper">
                <input type="range" id="sceneSlider" class="scene-slider" min="3" max="15" value="5" step="1" oninput="updateSceneCount(this.value)">
                
                <div class="slider-markers" id="sliderMarkers">
                    <!-- Markers akan di-generate oleh JavaScript -->
                </div>
            </div>
            
            <div class="duration-estimate" id="durationEstimate">
                <span class="duration-icon">‚è±Ô∏è</span>
                <span class="duration-text">Estimasi Durasi: <span id="durationMinutes">0</span> menit <span id="durationSeconds">50</span> detik</span>
                <span class="duration-badge" id="durationBadge">50 detik</span>
            </div>
        </div>
        
        <!-- GENERATE BUTTON -->
        <button class="btn-gen" id="genBtn" onclick="generateContent()" disabled>üåç GENERATE FAKTA UNIK</button>
        
        <!-- LOADING -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div id="loadText" style="font-weight: 600; color: var(--primary);">Processing...</div>
        </div>
        
        <!-- ERROR BOX -->
        <div id="errorBox"></div>

        <!-- OUTPUT AREA -->
        <div id="outputArea" style="display:none;">
            <div id="judulCard" class="card">
                <div class="card-header">
                    <span class="card-title">üî• Viral Title</span>
                    <button class="api-btn" onclick="copyJudul()" style="padding: 6px 12px; font-size: 10px;">Copy</button>
                </div>
                <div class="judul-text" id="judulText"></div>
            </div>
            
            <div id="naskahCard" class="card">
                <div class="card-header">
                    <span class="card-title">üìù Full Script</span>
                    <button class="api-btn" onclick="copyNaskah()" style="padding: 6px 12px; font-size: 10px;">Copy</button>
                </div>
                <div class="naskah-utama" id="naskahUtama"></div>
            </div>

            <div id="audioBox" class="audio-mini"></div>
            
            <div id="sceneInfo" class="scene-info"></div>
            
            <!-- COPY ALL BUTTONS - TTI & ITV -->
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <button class="copy-prompts-btn" onclick="copyAllTTI()" id="copyAllTTIBtn" style="background: #3b82f6; flex: 1; display: none;">
                    <span>üñºÔ∏è</span> COPY ALL TTI
                </button>
                <button class="copy-prompts-btn" onclick="copyAllITV()" id="copyAllITVBtn" style="background: #10b981; flex: 1; display: none;">
                    <span>üé¨</span> COPY ALL ITV
                </button>
            </div>
            <button class="copy-prompts-btn" onclick="copyAllPrompts()" id="copyPromptsBtn" style="display: none;">
                <span>üìã</span> COPY ALL PROMPTS (GABUNGAN)
            </button>
            <div id="promptsPreview" class="prompts-preview" style="display: none;"></div>
            
            <div id="sceneGrid" class="scene-grid"></div>
            
            <div id="copyBox" class="copy-mini">
                <button class="btn-gen" style="background: #111827;" onclick="copyAll()">üìã COPY ALL DATA</button>
            </div>
        </div>
    </div>
    
    <div id="notif" class="notification">‚úÖ Copied!</div>

    <!-- JavaScript Modules -->
    <script src="js/fungsi-utama.js"></script>
    <script src="js/mode-fakta.js"></script>
    <script src="js/mode-skeleton.js"></script>
    <script src="js/mode-islami.js"></script>
    
    <script>
        // ==================== FUNGSI UNTUK SLIDER ====================
        function updateSliderMarkers(value) {
            const markers = [3, 5, 7, 10, 12, 15];
            const markerContainer = document.getElementById('sliderMarkers');
            
            let html = '';
            markers.forEach(marker => {
                const isActive = marker <= value;
                html += `
                    <div class="marker-item">
                        <div class="marker-dot ${isActive ? 'active' : ''}"></div>
                        <div class="marker-label ${isActive ? 'active' : ''}">${marker}</div>
                    </div>
                `;
            });
            
            markerContainer.innerHTML = html;
        }

        function updateSceneCount(value) {
            document.getElementById('sceneCountValue').innerText = value;
            
            // Hitung estimasi durasi (10 detik per scene sebagai standar)
            const totalSeconds = value * 10;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            document.getElementById('durationMinutes').innerText = minutes;
            document.getElementById('durationSeconds').innerText = seconds;
            document.getElementById('durationBadge').innerText = `${totalSeconds} detik`;
            
            // Update markers
            updateSliderMarkers(value);
        }

        // ==================== FUNGSI VALIDASI ACCESS KEY ====================
        function validateAccessKey() {
            const inputKey = document.getElementById('accessKeyInput').value.trim();
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            // Reset styling
            errorDiv.style.display = 'none';
            errorDiv.style.animation = '';
            
            if (!inputKey) {
                errorText.innerText = "Key tidak boleh kosong!";
                errorDiv.style.display = 'block';
                errorDiv.style.animation = 'shake 0.3s ease';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
                return;
            }
            
            // Load access keys dari localStorage
            const savedKeys = localStorage.getItem('access_keys');
            let accessKeys = [];
            if (savedKeys) {
                accessKeys = JSON.parse(savedKeys);
            }
            
            console.log("üîë Mencari key:", inputKey);
            console.log("üìã Semua keys:", accessKeys);
            
            // Cari key di database
            const keyIndex = accessKeys.findIndex(k => k.key === inputKey);
            
            // KALAU KEY TIDAK DITEMUKAN
            if (keyIndex === -1) {
                console.log("‚ùå Key tidak ditemukan");
                errorText.innerText = "KEY EXPIRED!";
                errorDiv.style.display = 'block';
                errorDiv.style.animation = 'shake 0.3s ease';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    errorDiv.style.animation = '';
                }, 3000);
                return;
            }
            
            const keyData = accessKeys[keyIndex];
            console.log("‚úÖ Key ditemukan:", keyData);
            
            // KALAU KEY SUDAH PERNAH DIPAKAI (status success)
            if (keyData.status === 'success') {
                console.log("‚ùå Key sudah digunakan");
                errorText.innerText = "KEY ALREADY USED!";
                errorDiv.style.display = 'block';
                errorDiv.style.animation = 'shake 0.3s ease';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    errorDiv.style.animation = '';
                }, 3000);
                return;
            }
            
            // KALAU KEY SIAP DIPAKAI (status ready)
            if (keyData.status === 'ready') {
                console.log("‚úÖ Key ready, akan diubah menjadi success");
                
                // Dapatkan device ID dari fungsi utama
                const currentDeviceId = typeof deviceId !== 'undefined' ? deviceId : (typeof generateDeviceId === 'function' ? generateDeviceId() : 'unknown');
                
                // Update status key jadi success
                accessKeys[keyIndex].status = 'success';
                accessKeys[keyIndex].deviceId = currentDeviceId;
                accessKeys[keyIndex].usedAt = new Date().toISOString();
                
                // Simpan ke localStorage
                localStorage.setItem('access_keys', JSON.stringify(accessKeys));
                console.log("üíæ Key updated:", accessKeys[keyIndex]);
                
                // Daftarkan device
                const registeredDevices = JSON.parse(localStorage.getItem('registered_devices') || '{}');
                registeredDevices[currentDeviceId] = {
                    key: inputKey,
                    registeredAt: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    platform: navigator.platform
                };
                localStorage.setItem('registered_devices', JSON.stringify(registeredDevices));
                console.log("üíæ Device registered:", registeredDevices[currentDeviceId]);
                
                showNotif("‚úÖ Access granted! Selamat datang.");
                closeAccessModal();
                
                // Panggil checkAllStatus jika ada
                if (typeof checkAllStatus === 'function') {
                    checkAllStatus();
                }
                
            } else {
                console.log("‚ùå Status key tidak dikenal:", keyData.status);
                errorText.innerText = "Status key tidak valid!";
                errorDiv.style.display = 'block';
                errorDiv.style.animation = 'shake 0.3s ease';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    errorDiv.style.animation = '';
                }, 3000);
            }
        }

        // ==================== FUNGSI SHOW NOTIF ====================
        function showNotif(msg, type = 'success') {
            const n = document.getElementById('notif');
            if (n) {
                n.innerText = msg;
                n.style.backgroundColor = type === 'success' ? '#22c55e' : '#ef4444';
                n.style.display = 'block';
                setTimeout(() => n.style.display = 'none', 2000);
            } else {
                alert(msg);
            }
        }

        // ==================== FUNGSI CLOSE MODAL ====================
        function closeAccessModal() {
            document.getElementById('accessKeyModal').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        }

        // ==================== INISIALISASI ====================
        window.onload = async function() {
            // Set default slider value
            updateSceneCount(5);
            
            // Cek apakah initApp ada
            if (typeof initApp === 'function') {
                try {
                    await initApp();
                    // Default mode fakta
                    switchMode('fakta');
                } catch (e) {
                    console.error("Error initApp:", e);
                    document.getElementById('accessKeyModal').style.display = 'flex';
                }
            } else {
                console.error("initApp tidak ditemukan! Pastikan file js/fungsi-utama.js terload.");
                // Fallback: tampilkan modal key
                document.getElementById('accessKeyModal').style.display = 'flex';
            }
        };

        // Ekspor fungsi ke global
        window.validateAccessKey = validateAccessKey;
        window.showNotif = showNotif;
        window.closeAccessModal = closeAccessModal;
        window.updateSceneCount = updateSceneCount;
    </script>
</body>
</html>